#+TITLE: Definitions

* Air quality measurements
** Particulate matter
The introduction to the Wikipedia page on [[https://en.wikipedia.org/wiki/Particulates][Particulates]] has a lot of interesting
information and references.

Particulate matter can be natural or anthropogenic, and there are, of course,
many different types of particulate matter --- all solid or liquid matter
suspended in air. They are categorized by size. For instance, PM10 designates
particles of diameter 10μm or less, while PM2.5 designates particules of
diameter 2.5μm or less. Particulate matter is classifying as a group 1
carcinogen (by the WHO and the IARC, the international agency for research on
cancer), in that there is sufficient evidence of carcinogenic behavior in
humans. Typically the smaller the particulates, the greater the harm, as the
particles are able to more easily reach the bloodstream and brain.

European [[https://doi.org/10.1016/S1470-2045(13)70279-1][studies]] have shown that there is no safe level of particulate matter
and that for every increase of 10μg/m^3 in PM10 the lung cancer rate rose 22%.
The numbers are worse for PM2.5, for which every increase of 5µg/m^3, the lung
cancer rate rose 18%. Indeed, the large body of data on air quality and cancer,
heart disease, etc. has allowed scientists to establish causal links between the
presence of particulate matter and certain causes of death (see [[https://www.stateofglobalair.org/sites/default/files/soga-2018-report.pdf][here]], for
instance, on the burden of disease attributable to air pollution).

Interestingly, the bulk of particulate matter on Earth, by mass, has natural
origins (such as sea salt and mineral dust from wind-driven ocean spray and
desert sandstorms). These natural sources comprise about 90% of particulate
matter, though they are typically larger in size than anthropogenic
particulates (see [[https://earthobservatory.nasa.gov/features/Aerosols][here]]).

** Measurement
We may consider the mixture of particulate matter and air as an aerosol --- that
is, an air-soution. Hence particulates are typically measured in micrograms per
cubic meter. But how do air quality sensors measure these concentrations? It
seems that the standard approach is, roughly, to see how much light scatters
when shined through air. The results of these scattering measurements are then
used to determine the concentration of particulates of various sizes.

To go into a bit more detail, how do these computations work? We might start by
considering the toy problem of a single spherical particle (of a size comparable
to the wavelength of the laser light being shined through the air). The solution
to Maxwell's equations in this setup is due to Mie in 1908 (and others).
Presumably these solutions can be used, when scaled up to the case of multiple
particles, to determine the number and size of the particulates. See [[https://en.wikipedia.org/wiki/Mie_scattering][Wikipedia]]
for a description of Mie scattering.

** PurpleAir
PurpleAir's sensors use Plantower's PMS5003 and PMS1003 sensors. These sensors
push air through a cavity in which a laser is shined and scattering
cross-sections are measured (as sketched above). This seems to be a standard
design for particulate matter sensors. See
- [https://www.aqmd.gov/docs/default-source/aq-spec/resources-page/plantower-pms5003-manual_v2-3.pdf]
- [https://goughlui.com/2021/03/14/review-teardown-plantower-pms5003-laser-particulate-monitor-sensor/]
for some details on these particular sensors. Explanations of how a competitor's
sensors work are more readily available:
- [https://www.sensirion.com/en/about-us/newsroom/sensirion-specialist-articles/particulate-matter-sensing-for-air-quality-measurements/]

It seems, unfortunately, that the algorithms that these sensors use to analyze
the scattering data are proprietary. It would be interesting to see whether
there are companies that produce sensors equipped with free and open-source
algorithms. Sensirion, for instance, claims that their algorithms are more
discerning in terms of particulate matter that varies significantly in size.
They moreover claim that their sensors are protected from the overall buildup of
dust (which might otherwise bias the photocell's scattering measurements).
Thus it would not be surprising to find that different sensors give different
results (as the algorithms vary along with hardware) or that different sensor's
accuracies might drift at different rates.

PurpleAir tests the consistency of the Plantower sensors that they receive using
a smoke chamber test (see [[https://www2.purpleair.com/pages/technology][here]]), and have found no consistency issues. There is,
however, no mention of accuracy tests, say, comparing the Plantower sensors to
other laser particle sensors. This may be something to keep in mind when
comparing PurpleAir's data to other data using other laser sensors.

The Plantower sensors count suspended particles in sizes of 0.3, 0.5, 1.0, 2.5,
5.0, and 10µg. These counts are then apparently processed by PurpleAir sensors
"using a complex algorithm" to calculate the PM1.0, PM2.5, and PM10 mass
concentrations in µg/m^3. It is unclear why these counts need to be processed
via anything more than a simple algorithm --- perhaps to account for the
airflow, etc. unique to the PurpleAir sensors?

It is important to note that each PurpleAir sensor contains two Plantower
sensors, labelled A and B, for redundancy and consistency. The data shown on
PurpleAir's map can be viewed in various configurations. The default is "US EPA
PM 2.5 AQI".

** US EPA's AQI
The US EPA's Office of Air Quality Planning and Standards has a helpful document
(dated September 2018) for understanding what exactly the AQI is and how it is
calculated:
- [https://www.airnow.gov/sites/default/files/2020-05/aqi-technical-assistance-document-sept2018.pdf]
The AQI is a scale consisting of integers in the range of 0 to 500. Values
computed greater than 500 are considered off the AQI scale (and health
recommendations align with the highest AQI category). Note that AQI is computed
for any given pollutant. That is, we may have a PM2.5 AQI as well as a PM10 AQI
or an ozone AQI. Any given AQI is computed by a method described on p. 9 of
the above link using the breakpoints defined in the table on p. 10.

*** Example calculation
Consider the following example. At the time of writing, PurpleAir shows a sensor
labelled "SASA_PA2_SL_W" at W 15th and Clark in the South Loop reporting a 24
hour average US EPA PM2.5 AQI of 55. We can use Equation 1 to estimate,
conversely, what the 24 hour PM2.5 concentration is (in µg/m^3).
1. First we note that an AQI of 55 falls into the "Moderate" (indicated by the
   color yellow) category. The table tells us that the PM 2.5 concentration must
   be between 12.1 and 35.4 µg/m^3.
2. Equation 1 is now written
   \begin{equation}
    55 = \frac{100 - 51}{35.4 - 12.1} (C_{PM2.5} - 12.1) + 51
   \end{equation}
3. Solving for $C_{PM2.5}$ yields a PM2.5 concentration of approximately 14
   µg/m^3.
Note that, within each breakpoint/category, the AQI is simply an affine scaling
of the pollutant concentration. Why the definition is as such, and why the
breakpoints are chosen as they are, is not described in the document.

*** Visualization of concentration vs AQI
A quick visualization of how the PM2.5 concentration (in µg/m^3) translates to
the AQI index. The following code demonstrates how the affine scaling varies
from breakpoint interval to breakpoint interval.
#+begin_src python :results output
import math
import matplotlib.pyplot as plt

breakpoints = [
    (0, 12),
    (12.1, 35.4),
    (35.5, 55.4),
    (55.5, 150.4),
    (150.5, 250.4),
    (250.5, 350.4),
    (350.5, 500.4)
]
aqi_breakpoints = [
    (0, 50),
    (51, 100),
    (101, 150),
    (151, 200),
    (201, 300),
    (301, 400),
    (401, 500)
]

# make sure the two lists are the same length
assert len(breakpoints) = len(aqi_breakpoints)

# returns the index of the breakpoint interval, if found
# returns -1 otherwise
def bin(conc: float):
    for i, interval in enumerate(breakpoints):
        if conc >= interval[0] and conc <= interval[1]:
            return i
    return -1

# converts PM2.5 ug/m^3 concentrations to AQI
def concentration_to_aqi(conc: float):
    # clamp value
    if conc < breakpoints[0][0]:
        conc = breakpoints[0][0]
    if conc > breakpoints[-1][1]:
        conc = breakpoints[-1][1]
    # bin into breakpoint interval
    interval = bin(conc)
    # if the concentration falls between breakpoint intervals,
    # simply overestimate slightly
    if interval == -1:
        interval = bin(conc + 0.1)
    # return aqi
    bphi = breakpoints[interval][1]
    bplo = breakpoints[interval][0]
    ihi = aqi_breakpoints[interval][1]
    ilo = aqi_breakpoints[interval][0]
    return math.ceil((ihi - ilo) / (bphi - bplo) * (conc - bplo) + ilo)

# plot
x = range(0, 500)
y = list(map(concentration_to_aqi, x))
plt.xlabel("PM2.5 concentration (µg/m^3)")
plt.ylabel("US EPA AQI")
plt.grid(True)
plt.xticks([a for (a,b) in breakpoints])
plt.plot(x, y)
plt.show()
#+end_src

#+RESULTS:
: Text(0.5, 0, 'PM2.5 concentration (µg/m^3)')
: Text(0, 0.5, 'US EPA AQI')
: ([<matplotlib.axis.XTick object at 0x7fdfa4443bb0>, <matplotlib.axis.XTick object at 0x7fdfa4443b80>, <matplotlib.axis.XTick object at 0x7fdfa4436730>, <matplotlib.axis.XTick object at 0x7fdfa4233100>, <matplotlib.axis.XTick object at 0x7fdfa4233af0>, <matplotlib.axis.XTick object at 0x7fdfa4233730>, <matplotlib.axis.XTick object at 0x7fdfa42371f0>], [Text(0, 0, ''), Text(0, 0, ''), Text(0, 0, ''), Text(0, 0, ''), Text(0, 0, ''), Text(0, 0, ''), Text(0, 0, '')])
: [<matplotlib.lines.Line2D object at 0x7fdfa4237850>]

*** PurpleAir vs EPA
As PurpleAir uses the US EPA's AQI, the definitions are trivally in agreement.
Agreement in definition, of course, need not yield agreement in practice, due to
experimental error.

There are quite a few PurpleAir sensors located throughout parts of Chicago.
There are not many AirNow sensors in Chicago, however, and they are moreover not
distributed throughout.
